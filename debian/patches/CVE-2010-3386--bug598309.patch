From deaf85d7aa5f074ba18bfe5deb5605dfa22bf772 Mon Sep 17 00:00:00 2001
From: Jari Aalto <jari.aalto@cante.net>
Date: Sat, 16 Oct 2010 18:35:58 +0300
Subject: [PATCH] CVE-2010-3386 insecure library loading Bug#598309
Organization: Private
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 8bit


Signed-off-by: Jari Aalto <jari.aalto@cante.net>
---
 usttrace |   18 ++++++++++++++++--
 1 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/usttrace b/usttrace
index dc159f2..7e0f7bc 100755
--- a/usttrace
+++ b/usttrace
@@ -3,6 +3,16 @@
 # usttrace  by Pierre-Marc Fournier 2009
 # Distributed under the GPLv2.
 
+pathclean() {
+   # Vulnerability fix for insecure path content
+   # Make sure "::", "^:" or ":$" is not left in path arg $1
+
+   local tmp
+   tmp=$(echo "$1" | sed -e 's/::\+// ; s/^:// ; s/:$//' )
+
+   [ "$tmp" ] && echo "$tmp"
+}
+
 function error() {
 	echo "$0: error: $1" 2>/dev/stderr
 }
@@ -133,7 +143,9 @@ fi
     if [ "$arg_preload_libust" = "1" ];
     then
 	if [ -n "${LIBUST_PATH%libust.so}" ] ; then
-	    export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:${LIBUST_PATH%libust.so}"
+	    LD_LIBRARY_PATH="${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}${LIBUST_PATH%libust.so}"
+	    LD_LIBRARY_PATH=$(pathclean "$LD_LIBRARY_PATH")
+	    export LD_LIBRARY_PATH
 	fi
 	export LD_PRELOAD="$LD_PRELOAD:$LIBUST_PATH"
     fi
@@ -141,7 +153,9 @@ fi
     if [ "$arg_ld_std_ust" = "1" ];
     then
 	if [ -n "$${LIBUST_PATH%libust.so}" ] ; then
-	    export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:${LIBUST_PATH%libust.so}"
+	    LD_LIBRARY_PATH="${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}${LIBUST_PATH%libust.so}"
+	    LD_LIBRARY_PATH=$(pathclean "$LD_LIBRARY_PATH")
+	    export LD_LIBRARY_PATH
 	fi
     fi
 
-- 
1.7.1

